name: Deploy to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Validate Application
        run: |
          echo "🔍 Validating PaiNaiDee 3D Map..."
          
          # Check required files
          test -f index.html || (echo "❌ index.html missing" && exit 1)
          test -f script.js || (echo "❌ script.js missing" && exit 1)
          test -f styles.css || (echo "❌ styles.css missing" && exit 1)
          
          # Validate HTML structure
          grep -q "<!DOCTYPE html>" index.html || (echo "❌ Missing DOCTYPE" && exit 1)
          grep -q "PaiNaiDee 3D Map" index.html || (echo "❌ Missing title" && exit 1)
          
          # Validate JavaScript syntax
          node -c script.js || (echo "❌ JavaScript syntax error" && exit 1)
          
          # Check for CSS content
          test -s styles.css || (echo "❌ CSS file is empty" && exit 1)
          
          echo "✅ All validation checks passed!"
          
      - name: Test Application
        run: |
          echo "🧪 Testing application startup..."
          
          # Start server in background
          python3 -m http.server 8000 &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 3
          
          # Test if application loads
          curl -f http://localhost:8000/ > /dev/null || (echo "❌ Application failed to load" && exit 1)
          
          # Check for key content
          curl -s http://localhost:8000/ | grep -q "PaiNaiDee 3D Map" || (echo "❌ Content validation failed" && exit 1)
          
          # Clean up
          kill $SERVER_PID
          
          echo "✅ Application test passed!"
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment Success
        run: |
          echo "🚀 PaiNaiDee 3D Map deployed successfully!"
          echo "📍 Live URL: ${{ steps.deployment.outputs.page_url }}"
          echo "✅ Deployment completed at $(date)"